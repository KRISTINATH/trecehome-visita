<!-- HTML COMPLETO ACTUALIZADO -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>TreceHome - Parte de Visita</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h1>Parte de Visita</h1>
  <form id="visita-form">
    <label>Referencia del Inmueble</label>
    <input type="text" name="referencia" required />
    <label>Nombre del cliente</label>
    <input type="text" name="cliente" required />
    <label>DNI</label>
    <input type="text" name="dni" required />
    <label>Teléfono</label>
    <input type="tel" name="telefono" required />
    <label>Email</label>
    <input type="email" name="email" required />
    <label>Dirección del inmueble visitado</label>
    <input type="text" name="direccion" required />
    <label>Fecha</label>
    <input type="date" name="fecha" required />
    <label>Agente Inmobiliario</label>
    <select name="agente">
      <option>Kristina K</option>
      <option>Sergio A</option>
      <option>Diego A</option>
      <option>Sergio JR</option>
    </select>
    <canvas id="firma-cliente" width="300" height="100"></canvas>
    <canvas id="firma-agente" width="300" height="100"></canvas>
    <button type="submit">Generar PDF y Guardar en Drive</button>
  </form>

  <script>
    const { jsPDF } = window.jspdf;
    const scriptUrl = "https://script.google.com/macros/s/AKfycbziA2VFfKWQ8HXktqdWAXChhyAHO-v--_jFO54sUVeMQWTzrZzrwx_NlvgKTzy-FVz8GQ/exec";

    document.getElementById("visita-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      const form = e.target;
      const referencia = form.referencia.value;
      const cliente = form.cliente.value;
      const dni = form.dni.value;
      const telefono = form.telefono.value;
      const email = form.email.value;
      const direccion = form.direccion.value;
      const fecha = form.fecha.value;
      const agente = form.agente.value;

      const firmaCliente = document.getElementById("firma-cliente").toDataURL("image/png");
      const firmaAgente = document.getElementById("firma-agente").toDataURL("image/png");

      const doc = new jsPDF({ format: 'a5', unit: 'mm' });
      doc.setFontSize(12);
      doc.text(`Parte de Visita - TreceHome`, 10, 10);
      doc.text(`Referencia: ${referencia}`, 10, 20);
      doc.text(`Cliente: ${cliente}`, 10, 30);
      doc.text(`DNI: ${dni}`, 10, 40);
      doc.text(`Email: ${email}`, 10, 50);
      doc.text(`Teléfono: ${telefono}`, 10, 60);
      doc.text(`Dirección: ${direccion}`, 10, 70);
      doc.text(`Fecha: ${fecha}`, 10, 80);
      doc.text(`Agente: ${agente}`, 10, 90);
      doc.addImage(firmaCliente, "PNG", 10, 100, 60, 20);
      doc.addImage(firmaAgente, "PNG", 75, 100, 60, 20);
      doc.setFontSize(7);
      doc.setTextColor(100);
      doc.setFont("times", "italic");
      doc.text("Mediante la firma de esta hoja de visita, usted autoriza expresamente a TRECE HOME a tratar sus datos personales conforme al RGPD...", 10, 130, { maxWidth: 130 });
      doc.text("Asimismo, reconoce y acepta que TRECE HOME actúa como intermediario exclusivo en la venta...", 10, 140, { maxWidth: 130 });

      const pdfOutput = doc.output("datauristring");
      const base64PDF = pdfOutput.split(",")[1];
      const now = new Date();
      const fechaStr = now.toISOString().slice(0,10).replace(/-/g, "");
      const horaStr = `${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
      const filename = `PV_${referencia}_${fechaStr}-${horaStr}.pdf`;

      await fetch(scriptUrl, {
        method: "POST",
        body: JSON.stringify({
          filename,
          base64PDF,
          referencia,
          cliente,
          dni,
          telefono,
          email,
          direccion,
          fecha,
          agente
        })
      });

      alert("PDF generado y enviado a Drive correctamente.");
      form.reset();
    });
  </script>
</body>
</html>
