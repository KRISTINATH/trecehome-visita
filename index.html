<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Parte de Visita - TreceHome</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    h1 { color: #633f1e; text-align: center; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-bottom: 10px; }
    canvas { border: 1px solid #ccc; width: 100%; height: 100px; }
    .firma-label { font-weight: bold; margin-top: 10px; }
    .disclaimer { font-size: 0.8em; font-style: italic; margin-top: 15px; }
    button { background: #633f1e; color: white; padding: 10px; border: none; margin-top: 15px; width: 100%; }
  </style>
</head>
<body>
  <h1>Parte de Visita</h1>
  <form id="visita-form">
    <label>Referencia del inmueble</label>
    <input name="referencia" required />
    <label>Nombre del cliente</label>
    <input name="cliente" required />
    <label>DNI</label>
    <input name="dni" required />
    <label>Teléfono</label>
    <input name="telefono" required />
    <label>Email</label>
    <input type="email" name="email" required />
    <label>Dirección del inmueble visitado</label>
    <input name="direccion" required />
    <label>Fecha</label>
    <input type="date" name="fecha" required />
    <label>Agente Inmobiliario</label>
    <select name="agente">
      <option>Kristina K</option>
      <option>Sergio A</option>
      <option>Diego A</option>
    </select>

    <div class="firma-label">Firma del cliente:</div>
    <canvas id="firma-cliente"></canvas>
    <button type="button" onclick="borrarFirma('firma-cliente')">Borrar Firma Cliente</button>

    <div class="firma-label">Firma del agente:</div>
    <canvas id="firma-agente"></canvas>
    <button type="button" onclick="borrarFirma('firma-agente')">Borrar Firma Agente</button>

    <p class="disclaimer">
      Mediante la firma de esta hoja de visita, usted autoriza expresamente a TRECE HOME a tratar sus datos personales conforme al RGPD y la Ley Orgánica 3/2018, con el fin de gestionar su interés en el inmueble visitado, facilitar información relevante y, en su caso, formalizar propuestas o contratos...
    </p>
    <p class="disclaimer">
      Asimismo, reconoce y acepta que TRECE HOME actúa como intermediario exclusivo en la venta/promoción de este inmueble...
    </p>

    <button type="submit">Generar y Enviar Parte</button>
  </form>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbpyJuJkYEgNl4iQOAfR2U4ZpaDSDtXlPPPa7oaZVYvfrxzQ_gKrtmJg1B_n-QzrQQo/exec";

    function borrarFirma(id) {
      const c = document.getElementById(id);
      const ctx = c.getContext("2d");
      ctx.clearRect(0, 0, c.width, c.height);
    }

    function enableDraw(canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext("2d");
      let drawing = false;
      canvas.addEventListener("mousedown", e => {
        drawing = true;
        ctx.moveTo(e.offsetX, e.offsetY);
      });
      canvas.addEventListener("mousemove", e => {
        if (!drawing) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      });
      canvas.addEventListener("mouseup", () => drawing = false);
      canvas.addEventListener("mouseout", () => drawing = false);

      // Mobile
      canvas.addEventListener("touchstart", e => {
        drawing = true;
        const t = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        ctx.moveTo(t.clientX - rect.left, t.clientY - rect.top);
      });
      canvas.addEventListener("touchmove", e => {
        e.preventDefault();
        if (!drawing) return;
        const t = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        ctx.lineTo(t.clientX - rect.left, t.clientY - rect.top);
        ctx.stroke();
      });
      canvas.addEventListener("touchend", () => drawing = false);
    }

    enableDraw("firma-cliente");
    enableDraw("firma-agente");

    document.getElementById("visita-form").addEventListener("submit", async e => {
      e.preventDefault();

      const jsPDF = window.jspdf.jsPDF;
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());
      const firmaCliente = document.getElementById("firma-cliente").toDataURL("image/png");
      const firmaAgente = document.getElementById("firma-agente").toDataURL("image/png");

      const now = new Date();
      const fechaStr = now.toISOString().slice(0,10).replace(/-/g,"");
      const horaStr = now.getHours().toString().padStart(2,"0")+now.getMinutes().toString().padStart(2,"0");
      const filename = `PV_${data.referencia}_${fechaStr}-${horaStr}.pdf`;

      const pdf = new jsPDF({ format: "a5", unit: "mm" });
      pdf.setFontSize(12);
      pdf.text(`Parte de Visita - TreceHome`, 10, 10);
      pdf.text(`Cliente: ${data.cliente}`, 10, 20);
      pdf.text(`DNI: ${data.dni}`, 10, 28);
      pdf.text(`Teléfono: ${data.telefono}`, 10, 36);
      pdf.text(`Email: ${data.email}`, 10, 44);
      pdf.text(`Dirección: ${data.direccion}`, 10, 52);
      pdf.text(`Fecha: ${data.fecha}`, 10, 60);
      pdf.text(`Agente: ${data.agente}`, 10, 68);
      pdf.addImage(firmaCliente, "PNG", 10, 75, 60, 20);
      pdf.addImage(firmaAgente, "PNG", 80, 75, 60, 20);
      pdf.setFontSize(6);
      pdf.text("Mediante la firma de esta hoja de visita, usted autoriza expresamente a TRECE HOME a tratar sus datos personales conforme al RGPD y la Ley Orgánica 3/2018, con el fin de gestionar su interés en el inmueble visitado, facilitar información relevante y, en su caso, formalizar propuestas o contratos.", 10, 100, { maxWidth: 130 });
      pdf.text("Asimismo, reconoce y acepta que TRECE HOME actúa como intermediario exclusivo en la venta/promoción de este inmueble. En caso de que usted o persona vinculada adquiera el bien visitado en los próximos 12 meses —ya sea mediante contacto directo con el propietario, otra agencia o cualquier otro medio—, quedará obligado al abono de la comisión correspondiente sobre el precio de venta. TRECE HOME podrá reclamar judicialmente el cumplimiento de esta obligación.", 10, 110, { maxWidth: 130 });

      const pdfBase64 = pdf.output("datauristring").split(",")[1];

      try {
        await fetch(scriptUrl, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ...data,
            filename,
            base64PDF: pdfBase64
          })
        });

        alert("Parte de visita enviado correctamente.");
        form.reset();
      } catch (err) {
        alert("Error al enviar el PDF");
        console.error(err);
      }
    });
  </script>
</body>
</html>
